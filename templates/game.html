<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Jungle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Bootstrap CSS -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
        crossorigin="anonymous"
    />
  
    <!-- JS -->
    <script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        crossorigin="anonymous"
    ></script>
    <script
        src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script>
        $(document).ready(function() {
            game_page();
            clearInterval(intervalId);
            waiting = setInterval(function(){
                document.getElementById("game-problem").value = wait+"초 후에 시작됩니다.";
                wait--;
            }, 1000)
            setTimeout(function() {
                question(0);
                clearInterval(waiting);
                intervalId = setInterval(operateTimer, 10);
            }, 3000);
        });
        
        let tenMillis = 0;
        let minutes = 0;
        let seconds = 0;
        let wait = 2;
        let name;
        let intervalId;

        // 로그인 확인
        function game_page(){
            $.ajax({
                type: "GET",
                url: "/api/token",
                data: {},
                success: function(response){
                    if(response['result'] == 'success'){
                        name = response['id']
                        document.getElementById("dropdownMenuButton").textContent = name;
                    }
                    else{
                        alert('로그인 시간이 만료되었습니다.')
                        window.location.href = '/'
                    }
                }
            })
        }

        function question(i){
            let q_ls = [
            '잊지 마라, 네 인생의 주인은 너다.',
            '동료의 코드리뷰와 피드백을 감사히 여기자.',
            '물어보기 전에 최선의 내 답을 먼저 찾자.',
            '끝!'
            ]
            document.getElementById("game-problem").value = q_ls[i]
        }
        // 타이머
        // 10ms 마다 시간에 대한 숫자가 증가한다!
        function operateTimer(){
            tenMillis++;
            document.getElementById("tenMillis").textContent = tenMillis > 9 ?tenMillis : '0' + tenMillis
            if(tenMillis > 99){
              seconds++;
              document.getElementById("seconds").textContent = seconds > 9 ? seconds : '0' + seconds
              tenMillis = 0
              document.getElementById("tenMillis").textContent = "00"
            }
            if(seconds > 59){
              minutes++;
              document.getElementById("minutes").textContent = minutes > 9 ? minutes : '0' + minutes
              seconds = 0
              document.getElementById("seconds").textContent = "00" 
            }
        }
        
        // 답안 제출
        let cnt = 0;
        function submit(){
            if (document.getElementById("game-problem").value != $('#game-ans').val()){
                toast('틀렸습니다!');
                return
            }

            cnt++;
            question(cnt)
            document.getElementById("game-ans").value = null;
            document.getElementById("solved_cnt").textContent = cnt;
            if(cnt >= 3){
                saveResult();
            }
        }
        
        function saveResult() {
            let result = parseInt(document.getElementById("minutes").textContent) * 6000 + parseInt(document.getElementById("seconds").textContent) * 100 +
            parseInt(document.getElementById("tenMillis").textContent)
            $.ajax({
                type: "POST",
                url: "/api/log",
                data: {
                    id_give: name,
                    score_give: result
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        window.location.href = '/result'
                    } else {
                        alert('결과 저장 실패')
                        window.location.href = '/home'
                    }
                }
            })
        }

        // 로그아웃
        function logout(){
            alert('로그아웃 되었습니다.')
            $.removeCookie('mytoken')
            window.location.href = '/'
        }

        // 엔터키가 눌렸을 때
        function enterkey() {
            if (window.event.keyCode == 13) {
               submit();
            }
        }

        // 토스트 함수
        function toast(string) {
            const toast = document.getElementById("toast");
        
            toast.classList.contains("reveal") ?
                (clearTimeout(removeToast), removeToast = setTimeout(function () {
                    document.getElementById("toast").classList.remove("reveal")
                }, 1000)) :
                removeToast = setTimeout(function () {
                    document.getElementById("toast").classList.remove("reveal")
                }, 1000)
            toast.classList.add("reveal"),
                toast.innerText = string
        }
    </script>
</head>

<body>
    <nav class="navbar bg-body-tertiary justify-content-between" style="height: 10vh;">
        <a class="navbar-brand">
            <img src="{{ url_for('static', filename='typing-jungle_logo.png') }}" height="30px"
                onClick="gohome()">
        </a>
        <div class="form-inline">
            <!-- <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search"> -->
            <div class="dropdown mr-sm-2">
                <button class="btn btn-outline-success dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    userid
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="#">My page</a>
                </div>
            </div>
            <button class="btn btn-outline-success my-2 my-sm-0" type="" onclick="logout()">Log out</button>
        </div>
    </nav>

    <div class="main">
        <div class="game">
            <div class="game-form">
                <div class="form-group" id="game-form">
                    <!-- value에 문제 문장 넣기 -->
                  <input type="text" class="form-control" id="game-problem" value="3초 후에 시작됩니다." onpaste="return false;" oncopy="return false;" oncut="return false;" readonly>
                </div>
                <div class="form-group">
                  <label for="game-ans">Type the sentence above!</label>
                  <input type="text" class="form-control" id="game-ans" onkeyup="enterkey()" onpaste="return false;" oncopy="return false;" oncut="return false;">
                  <!-- js에서 document.getElementById('game-ans')의 value 값 얻어오면 됨. -->
                </div>
            </div>

            <div class="container text-center">
                <div class="row align-items-end">
                  <div class="col">
                    <div id="game-time">경과 시간 : 
                        <span id="minutes">00</span>:<span id="seconds">00</span>:<span id="tenMillis">00</span>
                    </div>
                    <div class="game-num">문제 수:
                        <span id="solved_cnt">0</span> / <span id="question_cnt">3</span>
                    </div>
                  </div>
                  <div class="col">
                  </div>
                  <div class="col">
                    <button id="game-ans-btn" onclick="submit()">Next</button>
                  </div>
                </div>
              </div>
        </div>

        <div id="toast"></div>
    </div>
</body>

</html>